#cloud-config
package_update: true
package_upgrade: true

runcmd:
  # -------- Disable Swap --------
  - swapoff -a
  - sed -i '/ swap / s/^/#/' /etc/fstab

  # -------- Kernel Modules --------
  - echo -e "overlay\nbr_netfilter" > /etc/modules-load.d/k8s.conf
  - modprobe overlay
  - modprobe br_netfilter

  # -------- Sysctl --------
  - |
    cat <<EOF > /etc/sysctl.d/k8s.conf
    net.bridge.bridge-nf-call-iptables=1
    net.bridge.bridge-nf-call-ip6tables=1
    net.ipv4.ip_forward=1
    EOF
  - sysctl --system

  # -------- Install CRI-O --------
  - dnf install -y crio
  - systemctl enable --now crio
  - systemctl is-active --quiet crio || exit 1

  # -------- Install kubeadm, kubelet, kubectl --------
  - curl -LO https://dl.k8s.io/release/v1.30.0/bin/linux/amd64/kubeadm
  - curl -LO https://dl.k8s.io/release/v1.30.0/bin/linux/amd64/kubelet
  - curl -LO https://dl.k8s.io/release/v1.30.0/bin/linux/amd64/kubectl
  - install -o root -g root -m 0755 kube* /usr/local/bin/
  - mkdir -p /etc/systemd/system/kubelet.service.d/

  # -------- Kubelet service --------
  - |
    cat <<EOF > /etc/systemd/system/kubelet.service
    [Unit]
    Description=kubelet
    After=crio.service
    Requires=crio.service

    [Service]
    ExecStart=/usr/local/bin/kubelet
    Restart=always

    [Install]
    WantedBy=multi-user.target
    EOF
  - systemctl daemon-reload
  - systemctl enable --now kubelet
  - systemctl is-active --quiet kubelet || exit 1

  # -------- Initialize Kubernetes Master --------
  - kubeadm init --pod-network-cidr=192.168.0.0/16 --ignore-preflight-errors=all | tee /root/kubeinit.txt

  # -------- Setup kubectl for ec2-user --------
  - mkdir -p /home/ec2-user/.kube
  - cp /etc/kubernetes/admin.conf /home/ec2-user/.kube/config
  - chown ec2-user:ec2-user /home/ec2-user/.kube/config

  # -------- Install Calico --------
  - sudo -u ec2-user kubectl apply -f https://docs.projectcalico.org/manifests/calico.yaml

  # -------- Verify API Server health --------
  - for i in {1..10}; do curl -sf --connect-timeout 5 https://127.0.0.1:6443/healthz && break || sleep 5; done
  - curl -sf --connect-timeout 5 https://127.0.0.1:6443/healthz || exit 1

  # -------- Save join command in SSM --------
  - JOIN_CMD=$(kubeadm token create --print-join-command)
  - aws ssm put-parameter --name "k8sJoinCommand" --value "$JOIN_CMD" --type String --overwrite --region ap-south-1
