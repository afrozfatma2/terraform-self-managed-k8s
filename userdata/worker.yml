#cloud-config
package_update: true
package_upgrade: true

runcmd:
  # -------------------- Disable Swap --------------------
  - swapoff -a
  - sed -i '/ swap / s/^/#/' /etc/fstab

  # -------------------- Kernel Modules --------------------
  - echo -e "overlay\nbr_netfilter" > /etc/modules-load.d/k8s.conf
  - modprobe overlay
  - modprobe br_netfilter

  # -------------------- Sysctl --------------------
  - |
    cat <<EOF > /etc/sysctl.d/k8s.conf
    net.bridge.bridge-nf-call-iptables=1
    net.bridge.bridge-nf-call-ip6tables=1
    net.ipv4.ip_forward=1
    EOF
  - sysctl --system

  # -------------------- Install CRI-O --------------------
  - dnf install -y crio
  - systemctl enable --now crio

  # -------------------- Install Kubernetes Binaries --------------------
  - curl -LO https://dl.k8s.io/release/v1.30.0/bin/linux/amd64/kubeadm
  - curl -LO https://dl.k8s.io/release/v1.30.0/bin/linux/amd64/kubelet
  - curl -LO https://dl.k8s.io/release/v1.30.0/bin/linux/amd64/kubectl
  - chmod +x kube*
  - mv kube* /usr/local/bin/
  - mkdir -p /etc/systemd/system/kubelet.service.d/

  # Kubelet service
  - |
    cat <<EOF > /etc/systemd/system/kubelet.service
    [Unit]
    Description=kubelet
    After=crio.service
    Requires=crio.service

    [Service]
    ExecStart=/usr/local/bin/kubelet
    Restart=always

    [Install]
    WantedBy=multi-user.target
    EOF
  - systemctl daemon-reload
  - systemctl enable --now kubelet

  # -------------------- Fetch Join Command from SSM and Join Cluster --------------------
  - JOIN_CMD=$(aws ssm get-parameter --name "k8sJoinCommand" --region ap-south-1 --query "Parameter.Value" --output text)
  - $JOIN_CMD

  # -------------------- Health Check --------------------
  - |
    systemctl is-active crio || exit 1
    systemctl is-active kubelet || exit 1
    kubectl get nodes || exit 1
